<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp|Material+Icons+Two+Tone"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Foldit:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/addUser.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"
    />
    <script
      src="https://code.jquery.com/jquery-2.2.4.min.js"
      integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
      crossorigin="anonymous"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <title>Update Movie</title>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="https://tmdb-rethunk.vercel.app/tmdb.png" />
            <h2>TMDB<span class="danger">ORG</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp"> close </span>
          </div>
        </div>

        <div class="sidebar">
          <a href="/Dashboard/index.html">
            <span class="material-icons-sharp"> dashboard </span>
            <h3>Dashboard</h3>
          </a>
          <a href="/Dashboard/users.html">
            <span class="material-icons-sharp"> person_outline </span>
            <h3>Users</h3>
          </a>
          <a href="/Dashboard/movie.html">
            <span class="material-icons-sharp"> movie </span>
            <h3>Movie</h3>
          </a>

          <a href="#">
            <span class="material-icons-sharp"> mail_outline </span>
            <h3>Tickets</h3>
            <span class="message-count">27</span>
          </a>

          <a href="#">
            <span class="material-icons-sharp"> report_gmailerrorred </span>
            <h3>Reports</h3>
          </a>
          <a href="#">
            <span class="material-icons-sharp"> settings </span>
            <h3>Settings</h3>
          </a>
          <a href="#">
            <span class="material-icons-sharp"> add </span>
            <h3>New Login</h3>
          </a>
          <a href="#">
            <span class="material-icons-sharp"> logout </span>
            <h3>Logout</h3>
          </a>
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- Main Content -->
      <main>
        <h1 class="dashboard-heading">Update Movie</h1>
        <!-- Recent Orders Table -->

        <div>
          <form class="form-add-user" id="form-update-movie">
            <div class="form-field span-2">
              <span class="input-title">Title</span>
              <input
                type="text"
                class="form-field--input"
                name="title"
                id="title-movie"
              />
            </div>
            <div class="form-field span-2">
              <span class="input-title">Genres</span>
              <div class="checkbox-group form-radio movie">
                <label
                  ><input type="checkbox" name="genre" value="Action" />
                  Action</label
                >

                <label
                  ><input type="checkbox" name="genre" value="Adventure" />
                  Adventure</label
                >
                <label
                  ><input type="checkbox" name="genre" value="Animation" />
                  Animation</label
                >
                <label
                  ><input type="checkbox" name="genre" value="Comedy" />
                  Comedy</label
                >
                <label
                  ><input type="checkbox" name="genre" value="Crime" />
                  Crime</label
                >
                <label
                  ><input type="checkbox" name="genre" value="Drama" />
                  Drama</label
                >
                <label
                  ><input type="checkbox" name="genre" value="Fantasy" />
                  Fantasy</label
                >
                <label
                  ><input type="checkbox" name="genre" value="History" />
                  History</label
                >
              </div>
            </div>
            <!-- ------------ poster ----------  -->
            <div class="form-field">
              <span class="input-title">Poster</span>
              <div class="form-field--file">
                <div class="fileUpload" id="fileUploadPosterWrap">
                  <input type="file" class="upload" id="fileUploadPoster" />
                  <span class="material-symbols-outlined"> cloud_upload </span>
                </div>
                <div
                  class="imagePoster imagePoster-relative"
                  id="imagePoster-wrap"
                >
                  <img src="" alt="" id="imagePoster" />
                  <div class="imagePoster-trash-icon">
                    <span class="material-symbols-outlined" id="iconTrash">
                      delete
                    </span>
                  </div>
                </div>
                <div class="progressBar" id="progressBar">
                  <div class="progress"></div>
                </div>
              </div>
            </div>

            <!-- ----------- bg -poster -----------  -->
            <div class="form-field">
              <span class="input-title">Background Poster</span>
              <div class="form-field--file">
                <div class="fileUpload" id="fileUploadPosterWrap2">
                  <input type="file" class="upload" id="fileUploadBgPoster" />
                  <span class="material-symbols-outlined"> cloud_upload </span>
                </div>
                <div
                  class="imagePoster imagePoster-relative"
                  id="imagePoster-wrap2"
                >
                  <img src="" alt="" id="imagePoster2" />
                  <div class="imagePoster-trash-icon">
                    <span
                      class="material-symbols-outlined"
                      id="iconTrashBgPoster"
                    >
                      delete
                    </span>
                  </div>
                </div>
                <div class="progressBar" id="progressBar2">
                  <div class="progress"></div>
                </div>
              </div>
            </div>

            <div class="form-field form-field-overview">
              <span class="input-title">Overview</span>

              <textarea rows="8" placeholder="" id="overview"> </textarea>
            </div>
            <button type="submit" class="notification add-user btn-add-user">
              <span class="material-icons-sharp"> add </span>
              <h3>Add Movie</h3>
            </button>
          </form>
        </div>
        <!-- End of Recent Orders -->
      </main>
      <!-- End of Main Content -->

      <!-- Right Section -->
      <div class="right-section">
        <div class="nav">
          <button id="menu-btn">
            <span class="material-icons-sharp"> menu </span>
          </button>
          <div class="dark-mode">
            <span class="material-icons-sharp active"> light_mode </span>
            <span class="material-icons-sharp"> dark_mode </span>
          </div>

          <div class="profile">
            <div class="info">
              <p>Hey, <b>Reza</b></p>
              <small class="text-muted">Admin</small>
            </div>
            <div class="profile-photo">
              <img src="images/profile-1.jpg" />
            </div>
          </div>
        </div>
        <!-- End of Nav -->

        <div class="user-profile">
          <div class="logo">
            <img src="https://tmdb-rethunk.vercel.app/tmdb.png" />
            <h2>TMDB</h2>
            <p>The Movie Database</p>
          </div>
        </div>

        <div class="reminders">
          <div class="header">
            <h2>Reminders</h2>
            <span class="material-icons-sharp"> notifications_none </span>
          </div>

          <div class="notification">
            <div class="icon">
              <span class="material-icons-sharp"> volume_up </span>
            </div>
            <div class="content">
              <div class="info">
                <h3>Workshop</h3>
                <small class="text_muted"> 08:00 AM - 12:00 PM </small>
              </div>
              <span class="material-icons-sharp"> more_vert </span>
            </div>
          </div>

          <div class="notification deactive">
            <div class="icon">
              <span class="material-icons-sharp"> edit </span>
            </div>
            <div class="content">
              <div class="info">
                <h3>Workshop</h3>
                <small class="text_muted"> 08:00 AM - 12:00 PM </small>
              </div>
              <span class="material-icons-sharp"> more_vert </span>
            </div>
          </div>

          <div class="notification add-reminder">
            <div>
              <span class="material-icons-sharp"> add </span>
              <h3>Add Reminder</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment-with-locales.min.js"></script>
    <script src="index.js" type="module"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
      integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="module">
      import {
        getDoc,
        updateDoc,
        doc,
        db,
        collection,
        addDoc,
        serverTimestamp,
        storage,
        ref,
        uploadBytesResumable,
        getDownloadURL,
      } from "../fireBaseConfig.js";

      // ==================== HANDEL UPDATE ====================

      // ---------------- SET VALUE -------------
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      var movieId = urlParams.get("id");
      const fileUploadPosterWrap = document.getElementById(
        "fileUploadPosterWrap"
      );
      const imagePosterWrap = document.getElementById("imagePoster-wrap");
      const imagePoster = document.getElementById("imagePoster");
      const fileUploadPosterWrap2 = document.getElementById(
        "fileUploadPosterWrap2"
      );
      const inputPoster = document.getElementById("fileUploadPoster");
      const fileUploadBgPoster = document.getElementById("fileUploadBgPoster");

      let file;
      const progressbar = document.getElementById("progressBar");
      const progressbar2 = document.getElementById("progressBar2");
      const imagePosterWrap2 = document.getElementById("imagePoster-wrap2");
      const imagePoster2 = document.getElementById("imagePoster2");
      const iconTrash = document.getElementById("iconTrash");
      const iconTrashBgPoster = document.getElementById("iconTrashBgPoster");
      let overview = document.getElementById("overview");
      let title = document.getElementById("title-movie");
      let genres = document.querySelectorAll(
        ".form-radio input[name='genre']"
      );
      let posterImageUrl;
      let posterBgImageUrl;
      async function getData(movieId) {
        try {
          const docRef = doc(db, "movies", movieId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const docData = docSnap.data();
            console.log(
              "🚀 ~ file: update-user.html:289 ~ getData ~ docData:",
              docData
            );
            // Get form input values

            posterImageUrl = docData.posterImageUrl;
            posterBgImageUrl = docData.posterBgImageUrl;
            genres.forEach((genre) => {
              if (docData.selectedGenres.includes(genre.value)) {
                genre.checked = true;
              }
            });

            title.value = docData.title;
            overview.value = docData.overview;
            if (posterImageUrl) {
              fileUploadPosterWrap.style.display = "none";
              imagePosterWrap.style.display = "block";
              imagePoster.style.display = "block";
              imagePoster.setAttribute("src", posterImageUrl);
            }
            if (posterBgImageUrl) {
              fileUploadPosterWrap2.style.display = "none";
              imagePosterWrap2.style.display = "block";
              imagePoster2.style.display = "block";
              imagePoster2.setAttribute("src", posterBgImageUrl);
            }
            iconTrash.addEventListener("click", function () {
              fileUploadPosterWrap.style.display = "block";
              imagePosterWrap.style.display = "none";
              imagePoster.style.display = "none";
            });
            iconTrashBgPoster.addEventListener("click", function () {
              fileUploadPosterWrap2.style.display = "block";
              imagePosterWrap2.style.display = "none";
              imagePoster2.style.display = "none";
            });
          }
        } catch (error) {
          console.log(
            "🚀 ~ file: index.html:276 ~ button.addEventListener ~ error:",
            error
          );
        }
      }
      getData(movieId);

      // ---------------- UPADATE img---------

      inputPoster.addEventListener("change", function (event) {
        file = event.target.files[0];
        const metadata = {
          contentType: "image/jpeg",
        };

        // Upload file and metadata to the object 'images/mountains.jpg'
        const storageRef = ref(storage, "images/" + file?.name);
        const uploadTask = uploadBytesResumable(storageRef, file, metadata);

        // Listen for state changes, errors, and completion of the upload.
        uploadTask.on(
          "state_changed",
          (snapshot) => {
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            let progress =
              (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progress = Math.round(progress);

            progressbar.style.opacity = 1;
            progressbar.style.width = progress + "%";
            progressbar.innerHTML = progress + "%";
            switch (snapshot.state) {
              case "paused":
                console.log("Upload is paused");
                break;
              case "running":
                console.log("Upload is running");
                break;
            }
          },
          (error) => {
            switch (error.code) {
              case "storage/unauthorized":
                break;
              case "storage/canceled":
                break;

              // ...

              case "storage/unknown":
                break;
            }
          },
          () => {
            // Upload completed successfully, now we can get the download URL
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
              posterImageUrl = downloadURL;
              if (downloadURL) {
                fileUploadPosterWrap.style.display = "none";

                imagePosterWrap.style.display = "block";

                imagePoster.style.display = "block";
                imagePoster.setAttribute("src", downloadURL);
              }
            });
          }
        );
      });

      fileUploadBgPoster.addEventListener("change", function (event) {
        file = event.target.files[0];
        const metadata = {
          contentType: "image/jpeg",
        };

        // Upload file and metadata to the object 'images/mountains.jpg'
        const storageRef = ref(storage, "images/" + file?.name);
        const uploadTask = uploadBytesResumable(storageRef, file, metadata);

        // Listen for state changes, errors, and completion of the upload.
        uploadTask.on(
          "state_changed",
          (snapshot) => {
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            let progress =
              (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progress = Math.round(progress);

            progressbar2.style.opacity = 1;
            progressbar2.style.width = progress + "%";
            progressbar2.innerHTML = progress + "%";
            switch (snapshot.state) {
              case "paused":
                console.log("Upload is paused");
                break;
              case "running":
                console.log("Upload is running");
                break;
            }
          },
          (error) => {
            switch (error.code) {
              case "storage/unauthorized":
                break;
              case "storage/canceled":
                break;

              // ...

              case "storage/unknown":
                break;
            }
          },
          () => {
            // Upload completed successfully, now we can get the download URL
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
              posterBgImageUrl = downloadURL;
              if (downloadURL) {
                fileUploadPosterWrap2.style.display = "none";

                imagePosterWrap2.style.display = "block";

                imagePoster2.style.display = "block";
                imagePoster2.setAttribute("src", downloadURL);
              }
            });
          }
        );
      });

      // --------------- Submit ------------
      document.addEventListener("DOMContentLoaded", function () {
        const formUpdate = document.getElementById("form-update-movie");

        formUpdate.addEventListener("submit", handleUpdate);

        async function handleUpdate(e) {
          e.preventDefault();

          // Get form input values

          title = title.value;
          overview = overview.value;
          let selectedGenres = []; // Tạo một mảng để lưu trữ các giá trị được chọn

          let checkboxes = document.getElementsByName("genre"); // Lấy tất cả các input có name="genre"

          for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
              selectedGenres.push(checkboxes[i].value); // Nếu được chọn, thêm giá trị vào mảng
            }
          }
          // Kiểm tra nếu các trường input không được điền
          if (!title || !overview || !posterImageUrl || !posterBgImageUrl) {
            toastr.options = {
              positionClass: "toast-bottom-left",
            };
            toastr.error("Please fill out all fields.");
            return; // Ngừng xử lý tiếp theo nếu có trường input trống
          }

          try {
            const washingtonRef = doc(db, "movies", movieId);
            await updateDoc(washingtonRef, {
              title ,overview, posterImageUrl, posterBgImageUrl
            });
            toastr.options = {
              positionClass: "toast-bottom-left",
            };
            toastr.success("Update movie successfully");
          } catch (error) {
            console.log("🚀 ~ file: app.js:174 ~ handleEdit ~ error:", error);
          }
        }
      });
    </script>
  </body>
</html>
